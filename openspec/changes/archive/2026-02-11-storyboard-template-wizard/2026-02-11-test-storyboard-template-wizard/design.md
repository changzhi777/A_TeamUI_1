# 设计文档：测试分镜头导入向导

## 架构概览

### 测试架构

```
┌─────────────────────────────────────────────────────────────┐
│                    测试执行层                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ Playwright  │  │ Chrome MCP  │  │ ZAI MCP     │     │
│  │ 自动化测试   │  │ 截图分析    │  │ UI 分析     │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                    应用层                                │
│  ┌───────────────────────────────────────────────────┐   │
│  │         TemplateImportDialog 组件                 │   │
│  │  (步骤 1-6: 上传 → 验证 → 映射 → 预览 → 选项 → 结果) │
│  └───────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                    数据层                                │
│  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐  │
│  │ parseCSVFile │  │parseJSONFile │  │ convertTo... │  │
│  └──────────────┘  └──────────────┘  └─────────────┘  │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                    状态层                                │
│  ┌───────────────────────────────────────────────────┐   │
│  │         StoryboardStore (addShots)              │   │
│  └───────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## 测试工具选择

### 1. Playwright MCP 工具

**用途**：UI 自动化测试

```javascript
// 典型测试流程
1. 启动开发服务器
2. 导航到分镜头清单页面
3. 点击导入按钮
4. 上传测试文件
5. 验证每一步的界面状态
6. 验证最终导入结果
```

**优势**：
- 真实浏览器环境
- 支持截图和视频录制
- 精确的元素选择和交互

### 2. Chrome MCP 工具

**用途**：页面状态分析和截图

```javascript
// 典型分析流程
1. 获取页面当前内容
2. 分析 DOM 结构
3. 验证渲染状态
4. 截图对比
```

**优势**：
- 轻量级页面分析
- 快速截图能力
- 适合状态验证

### 3. ZAI MCP 工具

**用途**：UI 界面分析和对比

```javascript
// 典型分析流程
1. 获取界面截图
2. 分析布局和组件
3. 对比预期和实际状态
4. 生成分析报告
```

**优势**：
- 智能界面分析
- 视觉差异检测
- 自动化问题识别

## 测试数据设计

### 标准测试文件

```json
{
  "type": "storyboard-template",
  "version": "1.0",
  "templateType": "data",
  "templateName": "标准测试数据",
  "shots": [
    {
      "shotNumber": 1,
      "sceneNumber": "SC01",
      "shotSize": "远景",
      "cameraMovement": "固定",
      "duration": 8,
      "description": "测试描述1"
    }
  ]
}
```

### 边缘情况文件

| 文件类型 | 描述 | 预期结果 |
|---------|------|----------|
| 空文件 | `{"type": "storyboard-template", "shots": []}` | 显示警告：无数据 |
| 超大文件 | 包含 10000+ 分镜头 | 验证性能和分批处理 |
| 格式错误 | 缺少 `type` 字段 | 显示格式错误提示 |
| 无效 JSON | 语法错误的 JSON | 显示解析错误位置 |
| 超大文件 | > 10MB | 拒绝并显示文件大小限制 |

## 测试流程设计

### 阶段 1：环境准备

```
1. 启动开发服务器 (pnpm run dev)
2. 准备测试文件集合
3. 初始化测试状态记录
```

### 阶段 2：功能测试

```
测试用例 1: 标准 JSON 导入
- 步骤: 上传标准测试文件 → 完成所有步骤 → 验证导入结果
- 预期: 所有分镜头正确导入，无错误

测试用例 2: 空文件处理
- 步骤: 上传空 JSON 文件 → 验证错误提示
- 预期: 显示友好的空文件提示

测试用例 3: 格式错误处理
- 步骤: 上传格式错误的文件 → 验证错误信息
- 预期: 显示详细的格式错误位置

测试用例 4: 大文件拒绝
- 步骤: 上传超过 10MB 的文件 → 验证提示
- 预期: 拒绝文件并显示大小限制

测试用例 5: 拖放交互
- 步骤: 拖放文件到上传区域 → 验证视觉反馈
- 预期: 拖放状态正确显示和切换
```

### 阶段 3：问题修复

```
对于每个发现的问题:
1. 创建详细的 bug 报告
2. 定位问题根源
3. 实施修复
4. 回归测试
5. 标记为已解决
```

## 错误检测机制

### 500 错误检测

```javascript
// 检测点
1. 浏览器控制台错误
2. 网络请求失败响应
3. Toast 错误提示
4. 步骤 6 的结果状态
```

### 数据验证

```javascript
// 验证点
1. 解析后的数据结构正确性
2. 导入后的分镜头数量
3. 镜头编号保持一致
4. 字段值正确映射
```

## 测试报告格式

### 简化测试报告结构

```markdown
# 分镜头导入向导测试报告

## 测试摘要
- 测试日期: YYYY-MM-DD
- 测试环境: 本地开发服务器
- 测试工具: Playwright MCP + Chrome MCP + ZAI MCP
- 总测试用例: X
- 通过: X
- 失败: X
- 阻塞: X

## 测试结果详情

### 测试用例 1: 标准 JSON 导入
- 状态: ✅ 通过 / ❌ 失败 / ⚠️ 部分通过
- 截图: [链接或内嵌]
- 备注: [描述]

### ... (其他测试用例)

## 发现的问题

### 问题 1: [问题标题]
- 严重性: 高/中/低
- 描述: [详细描述]
- 复现步骤: [步骤列表]
- 状态: 已修复 / 待修复 / 无法复现

## 建议
- [功能改进建议]
- [测试改进建议]
```

## 依赖关系

```
测试执行依赖:
├── 开发服务器运行 (pnpm run dev)
├── 测试文件准备完成
├── MCP 工具可用
└── 项目构建无错误

修复执行依赖:
├── 问题根源定位完成
├── 修复方案设计完成
└── 回归测试通过
```

## 时间估算

| 阶段 | 预估时间 |
|------|----------|
| 环境准备 | 5 分钟 |
| 功能测试执行 | 30-45 分钟 |
| 问题修复（如有） | 15-30 分钟/问题 |
| 报告生成 | 10 分钟 |
| **总计** | **1-2 小时** |
